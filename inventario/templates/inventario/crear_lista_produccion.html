{% extends 'inventario/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    .formset-row {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    /* Estilo para formularios que ser√°n eliminados (ocultos) */
    .delete-row {
        display: none !important;
    }
    
    .btn-add-mono {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-add-mono:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-remove-mono {
        background: linear-gradient(45deg, #dc3545, #e83e8c);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-remove-mono:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .mono-info {
        background-color: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 5px;
        padding: 8px;
        margin-top: 10px;
        font-size: 12px;
    }
    
    .cantidad-input {
        text-align: center;
        font-weight: bold;
    }
    
    /* Animaci√≥n para llamar atenci√≥n */
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .btn-pulse {
        animation: pulse 0.5s ease-in-out 3;
    }
    
    /* ========================================
       ESTILOS MEJORADOS PARA SELECT2
       ======================================== */
    
    /* Campo de selecci√≥n principal */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 42px !important;
        border: 2px solid #ced4da !important;
        border-radius: 6px !important;
        background-color: #ffffff !important;
        transition: all 0.3s ease;
    }
    
    .select2-container--bootstrap-5 .select2-selection:hover {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    
    .select2-container--bootstrap-5.select2-container--focus .select2-selection,
    .select2-container--bootstrap-5.select2-container--open .select2-selection {
        border-color: #667eea !important;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25) !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single {
        padding: 0.5rem 2.5rem 0.5rem 1rem !important;
    }
    
    /* Texto del placeholder */
    .select2-container--bootstrap-5 .select2-selection__placeholder {
        color: #6c757d !important;
        font-weight: 500;
    }
    
    /* Dropdown con b√∫squeda */
    .select2-dropdown {
        border: 2px solid #667eea !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        background-color: #ffffff !important;
    }
    
    /* Campo de b√∫squeda dentro del dropdown */
    .select2-search--dropdown .select2-search__field {
        border: 2px solid #ced4da !important;
        border-radius: 6px !important;
        padding: 8px 12px !important;
        font-size: 14px !important;
        background-color: #f8f9fa !important;
    }
    
    .select2-search--dropdown .select2-search__field:focus {
        border-color: #667eea !important;
        background-color: #ffffff !important;
        outline: none !important;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15) !important;
    }
    
    /* Opciones del dropdown */
    .select2-results__option {
        padding: 10px 15px !important;
        background-color: #ffffff !important;
        color: #212529 !important;
        font-size: 14px !important;
        transition: all 0.2s ease;
    }
    
    .select2-results__option:hover,
    .select2-results__option--highlighted {
        background-color: #e8ecff !important;
        color: #212529 !important;
    }
    
    .select2-results__option--selected {
        background-color: #667eea !important;
        color: #ffffff !important;
        font-weight: 600;
    }
    
    /* Formato personalizado de las opciones */
    .select2-mono-option {
        padding: 5px 0;
    }
    
    .select2-mono-option .fw-bold {
        font-size: 15px !important;
        color: #667eea !important;
        margin-bottom: 2px;
    }
    
    .select2-mono-option .text-muted {
        font-size: 13px !important;
        color: #6c757d !important;
    }
    
    .select2-results__option--highlighted .select2-mono-option .fw-bold {
        color: #4c5fd7 !important;
    }
    
    .select2-results__option--selected .select2-mono-option .fw-bold,
    .select2-results__option--selected .select2-mono-option .text-muted {
        color: #ffffff !important;
    }
    
    /* Mensaje cuando no hay resultados */
    .select2-results__option--no-results {
        background-color: #fff3cd !important;
        color: #856404 !important;
        font-weight: 500;
        padding: 12px 15px !important;
    }
    
    /* Bot√≥n para limpiar selecci√≥n */
    .select2-selection__clear {
        color: #dc3545 !important;
        font-size: 20px !important;
        font-weight: bold !important;
        margin-right: 8px !important;
    }
    
    .select2-selection__clear:hover {
        color: #c82333 !important;
    }
    
    /* Flecha del dropdown */
    .select2-selection__arrow {
        height: 40px !important;
    }
    
    .select2-selection__arrow b {
        border-color: #667eea transparent transparent transparent !important;
        border-width: 6px 5px 0 5px !important;
    }
    
    .select2-container--open .select2-selection__arrow b {
        border-color: transparent transparent #667eea transparent !important;
        border-width: 0 5px 6px 5px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-list-ul me-2"></i>{{ titulo }}
                    </h4>
                </div>
                
                <div class="card-body">
                    <form method="post" id="lista-form">
                        {% csrf_token %}
                        
                        <!-- Informaci√≥n b√°sica de la lista -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                    <strong>Nombre de la Lista</strong>
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.help_text %}
                                    <div class="form-text">{{ form.nombre.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                                    <strong>Descripci√≥n (Opcional)</strong>
                                </label>
                                {{ form.descripcion }}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Secci√≥n de mo√±os -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-ribbon me-2"></i>Mo√±os a Producir
                                <span class="badge bg-primary ms-2" id="contador-monos">0</span>
                            </h5>
                            <button type="button" class="btn btn-add-mono" id="add-mono">
                                <i class="fas fa-plus me-1"></i>Agregar Mo√±o
                            </button>
                        </div>
                        
                        <!-- Formset de mo√±os -->
                        <div id="formset-container">
                            {{ formset.management_form }}
                            
                            <div id="formset-forms">
                                {% for form in formset %}
                                    <div class="formset-row" data-form-index="{{ forloop.counter0 }}">
                                        <div class="row align-items-center">
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <strong>Mo√±o</strong>
                                                </label>
                                                {{ form.monos }}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <strong>Cantidad</strong>
                                                </label>
                                                {{ form.cantidad }}
                                                <div class="form-text">{{ form.cantidad.help_text }}</div>
                                                <small class="text-muted tipo-venta-info">Se define autom√°ticamente seg√∫n el tipo del mo√±o</small>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                {% if formset.can_delete %}
                                                    <button type="button" class="btn btn-remove-mono delete-form" data-form-index="{{ forloop.counter0 }}">
                                                        <i class="fas fa-trash me-1"></i>Eliminar
                                                    </button>
                                                    {{ form.DELETE }}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Informaci√≥n del mo√±o seleccionado -->
                                        {% if user.userprofile.puede_ver_precios %}
                                        <div class="mono-info d-none" id="info-{{ forloop.counter0 }}">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Precio por mo√±o:</strong> $<span class="precio-mono">0.00</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Total estimado:</strong> $<span class="total-estimado">0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Resumen total -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Resumen de la Lista</h6>
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <strong>Total Mo√±os:</strong>
                                                <div class="h4 text-primary" id="total-monos">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Tipos de Mo√±os:</strong>
                                                <div class="h4 text-info" id="tipos-monos">0</div>
                                            </div>
                                            {% if user.userprofile.puede_ver_precios %}
                                            <div class="col-md-3">
                                                <strong>Ganancia Estimada:</strong>
                                                <div class="h4 text-success" id="ganancia-estimada">$0.00</div>
                                            </div>
                                            {% endif %}
                                            <div class="col-md-3">
                                                <strong>Estado:</strong>
                                                <div class="h6 text-muted">Borrador</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de acci√≥n -->
                        <div class="row mt-4">
                            <div class="col-12 text-end">
                                <a href="{% url 'inventario:historial_simulaciones' %}" class="btn btn-secondary me-2">
                                    <i class="fas fa-arrow-left me-1"></i>Cancelar
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-1"></i>Crear Lista de Producci√≥n
                                </button>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevos formularios -->
<div id="empty-form-template" class="d-none">
    <div class="formset-row" data-form-index="__prefix__">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label">
                    <strong>Mo√±o</strong>
                </label>
            </div>
            <div class="col-md-4">
                <label class="form-label">
                    <strong>Cantidad</strong>
                </label>
                <input type="number" name="form-__prefix__-cantidad" class="form-control cantidad-input" min="1" value="1" placeholder="1">
                <div class="form-text">Cantidad a producir (pares o individuales seg√∫n el tipo del mo√±o)</div>
                <small class="text-muted tipo-venta-info">Se define autom√°ticamente seg√∫n el tipo del mo√±o</small>
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-remove-mono delete-form">
                    <i class="fas fa-trash me-1"></i>Eliminar
                </button>
            </div>
        </div>
        
        {% if user.userprofile.puede_ver_precios %}
        <div class="mono-info d-none" id="info-__prefix__">
            <div class="row">
                <div class="col-md-4">
                    <strong>Tipo de venta:</strong> <span class="tipo-venta">-</span>
                </div>
                <div class="col-md-4">
                    <strong>Precio por unidad:</strong> $<span class="precio-mono">0.00</span>
                </div>
                <div class="col-md-4">
                    <strong>Total estimado:</strong> $<span class="total-estimado">0.00</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Variables de Django para JavaScript -->
<script id="django-data" type="application/json">
{
    "formset": {
        "totalForms": {{ formset.total_form_count|default:"0" }},
        "maxForms": {{ formset.max_num|default:"1000" }}
    },
    "monos": [
        {% for mono in mo√±os_disponibles %}
        {
            "id": {{ mono.id }},
            "nombre": "{{ mono.nombre|escapejs }}",
            "codigo": "{{ mono.codigo|escapejs }}",
            "precio": {{ mono.precio_venta|floatformat:2|default:"0.00" }},
            "tipo_venta": "{{ mono.tipo_venta|default:'individual' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos de Django desde el script JSON
    const djangoData = JSON.parse(document.getElementById('django-data').textContent);
    
    console.log('üìä Datos cargados:', djangoData);
    console.log('üìã Mo√±os disponibles:', djangoData.monos ? djangoData.monos.length : 0);
    
    let formCount = djangoData.formset.totalForms || 0;
    const maxForms = djangoData.formset.maxForms || 1000;
    const mo√±osDisponibles = djangoData.monos || [];
    
    if (mo√±osDisponibles.length === 0) {
        console.warn('‚ö†Ô∏è No hay mo√±os disponibles para agregar');
    }
    
    const totalFormsInput = document.querySelector('[name$="-TOTAL_FORMS"]');
    
    // Validar que el input existe
    if (!totalFormsInput) {
        console.error('No se encontr√≥ el input TOTAL_FORMS');
        return;
    }
    
    // Funci√≥n para agregar nuevo formulario
    function addForm() {
        console.log('üîµ addForm() llamada - formCount:', formCount, 'maxForms:', maxForms);
        
        if (formCount >= maxForms) {
            console.warn('‚ö†Ô∏è Se alcanz√≥ el m√°ximo de formularios');
            alert('Se ha alcanzado el n√∫mero m√°ximo de mo√±os permitidos.');
            return;
        }
        
        const template = document.getElementById('empty-form-template');
        const container = document.getElementById('formset-forms');
        
        if (!template) {
            console.error('‚ùå No se encontr√≥ el template empty-form-template');
            return;
        }
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ el contenedor formset-forms');
            return;
        }
        
        console.log('‚úÖ Template y contenedor encontrados');
        
        const newForm = template.innerHTML.replace(/__prefix__/g, formCount);
        container.insertAdjacentHTML('beforeend', newForm);
        console.log('‚úÖ Formulario insertado en el DOM');
        
        // Crear y configurar el select de mo√±os
        const newFormDiv = container.lastElementChild;
        
        // Buscar el div que contiene el label de "Mo√±o" para insertar el select ah√≠
        const labelDiv = newFormDiv.querySelector('.col-md-4');
        
        if (!labelDiv) {
            console.error('‚ùå No se encontr√≥ el contenedor del label');
            return;
        }
        
        console.log('‚úÖ Contenedor del label encontrado');
        
        const select = document.createElement('select');
        select.name = `form-${formCount}-monos`;
        select.className = 'form-control mo√±os-select';
        select.required = true;
        select.innerHTML = '<option value="">Seleccionar mo√±o</option>';
        
        mo√±osDisponibles.forEach(mono => {
            const option = document.createElement('option');
            option.value = mono.id;
            option.textContent = `${mono.codigo} - ${mono.nombre}`;
            option.setAttribute('data-precio', mono.precio);
            option.setAttribute('data-tipo-venta', mono.tipo_venta);
            select.appendChild(option);
        });
        
        // Agregar el select despu√©s del label
        labelDiv.appendChild(select);
        console.log('‚úÖ Select de mo√±os creado y agregado');
        
        // Configurar eventos para el nuevo formulario
        configurarEventosFormulario(newFormDiv, formCount);
        
        formCount++;
        totalFormsInput.value = formCount;
        console.log('‚úÖ FormCount actualizado a:', formCount);
        
        actualizarResumen();
        console.log('‚úÖ Mo√±o agregado exitosamente');
        
        // Scroll suave al nuevo formulario
        setTimeout(() => {
            newFormDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight temporal del nuevo formulario
            newFormDiv.style.transition = 'all 0.3s';
            newFormDiv.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                newFormDiv.style.backgroundColor = '#f8f9fa';
            }, 1000);
        }, 100);
    }
    
    // Configurar eventos para formularios existentes
    document.querySelectorAll('.formset-row').forEach((formDiv, index) => {
        configurarEventosFormulario(formDiv, index);
    });
    
    // Eliminar formulario - Mejorado con confirmaci√≥n y logs
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-form')) {
            e.preventDefault();
            
            const button = e.target.closest('.delete-form');
            const formDiv = button.closest('.formset-row');
            
            if (!formDiv) {
                console.error('‚ùå No se encontr√≥ el formulario a eliminar');
                return;
            }
            
            console.log('üóëÔ∏è Intentando eliminar mo√±o...');
            
            // Confirmar eliminaci√≥n si el formulario tiene datos
            const monosSelect = formDiv.querySelector('[name$="-monos"]');
            const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
            
            let tienedatos = false;
            if (monosSelect && monosSelect.value) {
                tienedatos = true;
            }
            
            // Si tiene datos, pedir confirmaci√≥n
            if (tienedatos) {
                if (!confirm('¬øEst√°s seguro de eliminar este mo√±o de la lista?')) {
                    console.log('‚ö†Ô∏è Eliminaci√≥n cancelada por el usuario');
                    return;
                }
            }
            
            console.log('üóëÔ∏è Eliminando mo√±o...');
            
            const deleteInput = formDiv.querySelector('[name$="-DELETE"]');
            if (deleteInput) {
                // Es un formulario existente - marcarlo como DELETE y ocultarlo
                deleteInput.checked = true;
                console.log('‚úÖ Formulario existente marcado para eliminaci√≥n');
            } else {
                // Es un formulario nuevo - recalcular formCount
                formCount--;
                totalFormsInput.value = formCount;
                console.log('‚úÖ Formulario nuevo eliminado');
            }
            
            // Animaci√≥n de eliminaci√≥n para todos los casos
            formDiv.style.transition = 'all 0.3s ease-out';
            formDiv.style.opacity = '0';
            formDiv.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                formDiv.style.display = 'none'; // Ocultarlo completamente
                actualizarResumen();
                console.log('‚úÖ Mo√±o eliminado exitosamente');
            }, 300);
        }
    });
    
    function configurarEventosFormulario(formDiv, formIndex) {
        const monosSelect = formDiv.querySelector('[name$="-monos"]');
        const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
        const infoDiv = formDiv.querySelector('.mono-info');
        
        // Evento cambio de mo√±o
        if (monosSelect) {
            monosSelect.addEventListener('change', function() {
                if (this.value) {
                    const monoSeleccionado = mo√±osDisponibles.find(mono => mono.id == this.value);
                    if (monoSeleccionado) {
                        const precio = monoSeleccionado.precio;
                        const tipoVenta = monoSeleccionado.tipo_venta || 'individual';
                        
                        infoDiv.querySelector('.precio-mono').textContent = precio.toFixed(2);
                        infoDiv.querySelector('.tipo-venta').textContent = tipoVenta === 'par' ? 'Par' : 'Individual';
                        infoDiv.classList.remove('d-none');
                        calcularTotalFormulario(formDiv);
                    }
                } else {
                    infoDiv.classList.add('d-none');
                }
                actualizarResumen();
            });
        }
        
        // Evento cambio de cantidad
        if (cantidadInput) {
            cantidadInput.addEventListener('input', function() {
                calcularTotalFormulario(formDiv);
                actualizarResumen();
            });
        }
    }
    
    function calcularTotalFormulario(formDiv) {
        const monosSelect = formDiv.querySelector('[name$="-monos"]');
        const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
        
        if (!monosSelect || !monosSelect.value || !cantidadInput) return;
        
        const monoSeleccionado = mo√±osDisponibles.find(mono => mono.id == monosSelect.value);
        if (!monoSeleccionado) return;
        
        const precio = monoSeleccionado.precio;
        const cantidad = parseInt(cantidadInput.value || 0);
        const tipoVenta = monoSeleccionado.tipo_venta || 'individual';
        
        // Calcular total de mo√±os seg√∫n el tipo
        let totalMonos = cantidad;
        if (tipoVenta === 'par') {
            totalMonos = cantidad * 2; // Si es par, cada cantidad son 2 mo√±os
        }
        
        const total = precio * totalMonos;
        const totalSpan = formDiv.querySelector('.total-estimado');
        if (totalSpan) {
            totalSpan.textContent = total.toFixed(2);
        }
    }
    
    function actualizarResumen() {
        let totalMonos = 0;
        let tiposMonos = 0;
        let gananciaTotal = 0;
        
        // Filtrar solo formularios visibles y no marcados para eliminar
        document.querySelectorAll('.formset-row').forEach(formDiv => {
            // Saltar si est√° oculto o marcado para eliminar
            if (formDiv.style.display === 'none' || formDiv.classList.contains('delete-row')) {
                return;
            }
            
            const deleteInput = formDiv.querySelector('[name$="-DELETE"]');
            if (deleteInput && deleteInput.checked) return;
            
            const monosSelect = formDiv.querySelector('[name$="-monos"]');
            const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
            
            if (monosSelect && monosSelect.value && cantidadInput) {
                const cantidad = parseInt(cantidadInput.value || 0);
                
                if (cantidad > 0) {
                    tiposMonos++;
                    
                    // Calcular total de mo√±os seg√∫n el tipo
                    const monoSeleccionado = mo√±osDisponibles.find(mono => mono.id == monosSelect.value);
                    if (monoSeleccionado) {
                        const tipoVenta = monoSeleccionado.tipo_venta || 'individual';
                        let monosReales = cantidad;
                        if (tipoVenta === 'par') {
                            monosReales = cantidad * 2;
                        }
                        totalMonos += monosReales;
                        
                        const totalFormulario = parseFloat(formDiv.querySelector('.total-estimado')?.textContent || 0);
                        gananciaTotal += totalFormulario;
                    }
                }
            }
        });
        
        // Actualizar elementos con validaci√≥n
        const totalMonosEl = document.getElementById('total-monos');
        const tiposMonosEl = document.getElementById('tipos-monos');
        const gananciaEl = document.getElementById('ganancia-estimada');
        const contadorMonos = document.getElementById('contador-monos');
        
        if (totalMonosEl) totalMonosEl.textContent = totalMonos;
        if (tiposMonosEl) tiposMonosEl.textContent = tiposMonos;
        if (gananciaEl) gananciaEl.textContent = '$' + gananciaTotal.toFixed(2);
        
        // Actualizar contador visual de mo√±os activos
        if (contadorMonos) {
            contadorMonos.textContent = tiposMonos;
            // Cambiar color seg√∫n cantidad
            if (tiposMonos === 0) {
                contadorMonos.className = 'badge bg-secondary ms-2';
            } else if (tiposMonos < 5) {
                contadorMonos.className = 'badge bg-primary ms-2';
            } else {
                contadorMonos.className = 'badge bg-success ms-2';
            }
        }
    }
    
    // Event listeners para el bot√≥n de agregar
    const addButton = document.getElementById('add-mono');
    if (addButton) {
        addButton.addEventListener('click', addForm);
    } else {
        console.error('No se encontr√≥ el bot√≥n de agregar mo√±o');
    }
    
    // Event listeners para campos de cantidad
    document.addEventListener('input', function(e) {
        if (e.target.matches('[name$="-cantidad"]')) {
            const formDiv = e.target.closest('.formset-row');
            if (formDiv) {
                calcularTotalFormulario(formDiv);
                actualizarResumen();
            }
        }
    });
    
    // Validaci√≥n del formulario al enviar
    const listaForm = document.getElementById('lista-form');
    if (listaForm) {
        listaForm.addEventListener('submit', function(e) {
            // Contar mo√±os activos (visibles y no marcados para eliminar)
            let monosActivos = 0;
            document.querySelectorAll('.formset-row').forEach(formDiv => {
                // Saltar si est√° oculto
                if (formDiv.style.display === 'none' || formDiv.classList.contains('delete-row')) {
                    return;
                }
                
                const deleteInput = formDiv.querySelector('[name$="-DELETE"]');
                if (deleteInput && deleteInput.checked) return;
                
                const monosSelect = formDiv.querySelector('[name$="-monos"]');
                if (monosSelect && monosSelect.value) {
                    monosActivos++;
                }
            });
            
            if (monosActivos === 0) {
                e.preventDefault();
                alert('‚ö†Ô∏è Debes agregar al menos un mo√±o a la lista de producci√≥n.');
                console.error('‚ùå Intento de env√≠o sin mo√±os');
                
                // Resaltar el bot√≥n de agregar
                const addButton = document.getElementById('add-mono');
                if (addButton) {
                    addButton.style.animation = 'pulse 0.5s ease-in-out 3';
                    addButton.classList.add('btn-pulse');
                }
                
                return false;
            }
            
            console.log('‚úÖ Formulario v√°lido, enviando...');
        });
    }
    
    // Inicializar resumen despu√©s de que el DOM est√© listo
    setTimeout(function() {
        actualizarResumen();
    }, 100);
});
</script>

<!-- Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>

<script>
$(document).ready(function() {
    // Funci√≥n para inicializar Select2 en un select
    function initializeSelect2(selectElement) {
        $(selectElement).select2({
            theme: 'bootstrap-5',
            language: 'es',
            placeholder: 'üîç Buscar mo√±o...',
            allowClear: true,
            width: '100%',
            templateResult: formatMonoOption,
            templateSelection: formatMonoSelection
        });
    }
    
    // Formato personalizado para las opciones del dropdown
    function formatMonoOption(mono) {
        if (!mono.id) {
            return mono.text;
        }
        
        // Extraer informaci√≥n del texto (formato: "C√≥digo - Nombre")
        const text = mono.text;
        const parts = text.split(' - ');
        const codigo = parts[0] || '';
        const nombre = parts.slice(1).join(' - ') || '';
        
        var $mono = $(
            '<div class="select2-mono-option">' +
                '<div class="fw-bold text-primary">' + codigo + '</div>' +
                '<div class="text-muted small">' + nombre + '</div>' +
            '</div>'
        );
        return $mono;
    }
    
    // Formato para el elemento seleccionado
    function formatMonoSelection(mono) {
        return mono.text || mono.id;
    }
    
    // Inicializar Select2 en todos los selects de mo√±os existentes
    $('select[name$="-monos"]').each(function() {
        initializeSelect2(this);
    });
    
    // Cuando se a√±ade un nuevo formulario, inicializar Select2
    const originalAddForm = window.addForm;
    if (originalAddForm) {
        window.addForm = function() {
            originalAddForm();
            // Buscar el √∫ltimo select agregado e inicializar Select2
            setTimeout(function() {
                const lastSelect = $('select[name$="-monos"]').last();
                if (lastSelect.length && !lastSelect.hasClass('select2-hidden-accessible')) {
                    initializeSelect2(lastSelect);
                }
            }, 100);
        };
    }
});
</script>
{% endblock %}