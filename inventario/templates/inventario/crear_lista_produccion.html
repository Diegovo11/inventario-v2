{% extends 'inventario/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
    .formset-row {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
    }
    
    .delete-row {
        background-color: #ffe6e6 !important;
        opacity: 0.6;
    }
    
    .btn-add-mono {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 14px;
    }
    
    .btn-remove-mono {
        background: linear-gradient(45deg, #dc3545, #e83e8c);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .mono-info {
        background-color: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 5px;
        padding: 8px;
        margin-top: 10px;
        font-size: 12px;
    }
    
    .cantidad-input {
        text-align: center;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-list-ul me-2"></i>{{ titulo }}
                    </h4>
                </div>
                
                <div class="card-body">
                    <form method="post" id="lista-form">
                        {% csrf_token %}
                        
                        <!-- Informaci√≥n b√°sica de la lista -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                    <strong>Nombre de la Lista</strong>
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.help_text %}
                                    <div class="form-text">{{ form.nombre.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">
                                    <strong>Descripci√≥n (Opcional)</strong>
                                </label>
                                {{ form.descripcion }}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Secci√≥n de mo√±os -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-ribbon me-2"></i>Mo√±os a Producir
                            </h5>
                            <button type="button" class="btn btn-add-mono" id="add-mono">
                                <i class="fas fa-plus me-1"></i>Agregar Mo√±o
                            </button>
                        </div>
                        
                        <!-- Formset de mo√±os -->
                        <div id="formset-container">
                            {{ formset.management_form }}
                            
                            <div id="formset-forms">
                                {% for form in formset %}
                                    <div class="formset-row" data-form-index="{{ forloop.counter0 }}">
                                        <div class="row align-items-center">
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <strong>Mo√±o</strong>
                                                </label>
                                                {{ form.monos }}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">
                                                    <strong>Cantidad</strong>
                                                </label>
                                                {{ form.cantidad }}
                                                <div class="form-text">{{ form.cantidad.help_text }}</div>
                                                <small class="text-muted tipo-venta-info">Se define autom√°ticamente seg√∫n el tipo del mo√±o</small>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                {% if formset.can_delete %}
                                                    <button type="button" class="btn btn-remove-mono delete-form" data-form-index="{{ forloop.counter0 }}">
                                                        <i class="fas fa-trash me-1"></i>Eliminar
                                                    </button>
                                                    {{ form.DELETE }}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Informaci√≥n del mo√±o seleccionado -->
                                        <div class="mono-info d-none" id="info-{{ forloop.counter0 }}">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Precio por mo√±o:</strong> $<span class="precio-mono">0.00</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Total estimado:</strong> $<span class="total-estimado">0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Resumen total -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Resumen de la Lista</h6>
                                        <div class="row text-center">
                                            <div class="col-md-3">
                                                <strong>Total Mo√±os:</strong>
                                                <div class="h4 text-primary" id="total-monos">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Tipos de Mo√±os:</strong>
                                                <div class="h4 text-info" id="tipos-monos">0</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Ganancia Estimada:</strong>
                                                <div class="h4 text-success" id="ganancia-estimada">$0.00</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Estado:</strong>
                                                <div class="h6 text-muted">Borrador</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de acci√≥n -->
                        <div class="row mt-4">
                            <div class="col-12 text-end">
                                <a href="{% url 'inventario:historial_simulaciones' %}" class="btn btn-secondary me-2">
                                    <i class="fas fa-arrow-left me-1"></i>Cancelar
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-1"></i>Crear Lista de Producci√≥n
                                </button>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevos formularios -->
<div id="empty-form-template" class="d-none">
    <div class="formset-row" data-form-index="__prefix__">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label">
                    <strong>Mo√±o</strong>
                </label>
                <!-- Aqu√≠ se insertar√° el select din√°micamente -->
            </div>
            <div class="col-md-4">
                <label class="form-label">
                    <strong>Cantidad</strong>
                </label>
                <input type="number" name="form-__prefix__-cantidad" class="form-control cantidad-input" min="1" value="1" placeholder="1">
                <div class="form-text">Cantidad a producir (pares o individuales seg√∫n el tipo del mo√±o)</div>
                <small class="text-muted tipo-venta-info">Se define autom√°ticamente seg√∫n el tipo del mo√±o</small>
            </div>
            <div class="col-md-2 text-end">
                <button type="button" class="btn btn-remove-mono delete-form">
                    <i class="fas fa-trash me-1"></i>Eliminar
                </button>
            </div>
        </div>
        
        <div class="mono-info d-none" id="info-__prefix__">
            <div class="row">
                <div class="col-md-4">
                    <strong>Tipo de venta:</strong> <span class="tipo-venta">-</span>
                </div>
                <div class="col-md-4">
                    <strong>Precio por unidad:</strong> $<span class="precio-mono">0.00</span>
                </div>
                <div class="col-md-4">
                    <strong>Total estimado:</strong> $<span class="total-estimado">0.00</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Variables de Django para JavaScript -->
<script id="django-data" type="application/json">
{
    "formset": {
        "totalForms": {{ formset.total_form_count|default:"0" }},
        "maxForms": {{ formset.max_num|default:"1000" }}
    },
    "monos": [
        {% for mono in mo√±os_disponibles %}
        {
            "id": {{ mono.id }},
            "nombre": "{{ mono.nombre|escapejs }}",
            "codigo": "{{ mono.codigo|escapejs }}",
            "precio": {{ mono.precio_venta|floatformat:2|default:"0.00" }},
            "tipo_venta": "{{ mono.tipo_venta|default:'individual' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos de Django desde el script JSON
    const djangoData = JSON.parse(document.getElementById('django-data').textContent);
    
    let formCount = djangoData.formset.totalForms || 0;
    const maxForms = djangoData.formset.maxForms || 1000;
    const mo√±osDisponibles = djangoData.monos || [];
    
    const totalFormsInput = document.querySelector('[name$="-TOTAL_FORMS"]');
    
    // Validar que el input existe
    if (!totalFormsInput) {
        console.error('No se encontr√≥ el input TOTAL_FORMS');
        return;
    }
    
    // Funci√≥n para agregar nuevo formulario
    function addForm() {
        console.log('üîµ addForm() llamada - formCount:', formCount, 'maxForms:', maxForms);
        
        if (formCount >= maxForms) {
            console.warn('‚ö†Ô∏è Se alcanz√≥ el m√°ximo de formularios');
            alert('Se ha alcanzado el n√∫mero m√°ximo de mo√±os permitidos.');
            return;
        }
        
        const template = document.getElementById('empty-form-template');
        const container = document.getElementById('formset-forms');
        
        if (!template) {
            console.error('‚ùå No se encontr√≥ el template empty-form-template');
            return;
        }
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ el contenedor formset-forms');
            return;
        }
        
        console.log('‚úÖ Template y contenedor encontrados');
        
        const newForm = template.innerHTML.replace(/__prefix__/g, formCount);
        container.insertAdjacentHTML('beforeend', newForm);
        console.log('‚úÖ Formulario insertado en el DOM');
        
        // Crear y configurar el select de mo√±os
        const newFormDiv = container.lastElementChild;
        const selectContainer = newFormDiv.querySelector('.col-md-4 label').nextElementSibling;
        
        if (!selectContainer) {
            console.error('‚ùå No se encontr√≥ el contenedor del select');
            return;
        }
        
        const select = document.createElement('select');
        select.name = `form-${formCount}-monos`;
        select.className = 'form-control mo√±os-select';
        select.innerHTML = '<option value="">Seleccionar mo√±o</option>';
        
        mo√±osDisponibles.forEach(mono => {
            const option = document.createElement('option');
            option.value = mono.id;
            option.textContent = `${mono.codigo} - ${mono.nombre}`;
            option.setAttribute('data-precio', mono.precio);
            option.setAttribute('data-tipo-venta', mono.tipo_venta);
            select.appendChild(option);
        });
        
        selectContainer.replaceWith(select);
        console.log('‚úÖ Select de mo√±os creado y agregado');
        
        // Configurar eventos para el nuevo formulario
        configurarEventosFormulario(newFormDiv, formCount);
        
        formCount++;
        totalFormsInput.value = formCount;
        console.log('‚úÖ FormCount actualizado a:', formCount);
        
        actualizarResumen();
        console.log('‚úÖ Mo√±o agregado exitosamente');
    }
    
    // Configurar eventos para formularios existentes
    document.querySelectorAll('.formset-row').forEach((formDiv, index) => {
        configurarEventosFormulario(formDiv, index);
    });
    
    // Eliminar formulario
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-form')) {
            const formDiv = e.target.closest('.formset-row');
            formDiv.classList.add('delete-row');
            
            const deleteInput = formDiv.querySelector('[name$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
            } else {
                formDiv.remove();
            }
            
            actualizarResumen();
        }
    });
    
    function configurarEventosFormulario(formDiv, formIndex) {
        const monosSelect = formDiv.querySelector('[name$="-monos"]');
        const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
        const infoDiv = formDiv.querySelector('.mono-info');
        
        // Evento cambio de mo√±o
        if (monosSelect) {
            monosSelect.addEventListener('change', function() {
                if (this.value) {
                    const monoSeleccionado = mo√±osDisponibles.find(mono => mono.id == this.value);
                    if (monoSeleccionado) {
                        const precio = monoSeleccionado.precio;
                        const tipoVenta = monoSeleccionado.tipo_venta || 'individual';
                        
                        infoDiv.querySelector('.precio-mono').textContent = precio.toFixed(2);
                        infoDiv.querySelector('.tipo-venta').textContent = tipoVenta === 'par' ? 'Par' : 'Individual';
                        infoDiv.classList.remove('d-none');
                        calcularTotalFormulario(formDiv);
                    }
                } else {
                    infoDiv.classList.add('d-none');
                }
                actualizarResumen();
            });
        }
        
        // Evento cambio de cantidad
        if (cantidadInput) {
            cantidadInput.addEventListener('input', function() {
                calcularTotalFormulario(formDiv);
                actualizarResumen();
            });
        }
    }
    
    function calcularTotalFormulario(formDiv) {
        const monosSelect = formDiv.querySelector('[name$="-monos"]');
        const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
        
        if (!monosSelect || !monosSelect.value || !cantidadInput) return;
        
        const monoSeleccionado = mo√±osDisponibles.find(mono => mono.id == monosSelect.value);
        if (!monoSeleccionado) return;
        
        const precio = monoSeleccionado.precio;
        const cantidad = parseInt(cantidadInput.value || 0);
        const tipoVenta = monoSeleccionado.tipo_venta || 'individual';
        
        // Calcular total de mo√±os seg√∫n el tipo
        let totalMonos = cantidad;
        if (tipoVenta === 'par') {
            totalMonos = cantidad * 2; // Si es par, cada cantidad son 2 mo√±os
        }
        
        const total = precio * totalMonos;
        const totalSpan = formDiv.querySelector('.total-estimado');
        if (totalSpan) {
            totalSpan.textContent = total.toFixed(2);
        }
    }
    
    function actualizarResumen() {
        let totalMonos = 0;
        let tiposMonos = 0;
        let gananciaTotal = 0;
        
        document.querySelectorAll('.formset-row:not(.delete-row)').forEach(formDiv => {
            const deleteInput = formDiv.querySelector('[name$="-DELETE"]');
            if (deleteInput && deleteInput.checked) return;
            
            const monosSelect = formDiv.querySelector('[name$="-monos"]');
            const cantidadInput = formDiv.querySelector('[name$="-cantidad"]');
            
            if (monosSelect && monosSelect.value && cantidadInput) {
                const cantidad = parseInt(cantidadInput.value || 0);
                
                if (cantidad > 0) {
                    tiposMonos++;
                    
                    // Calcular total de mo√±os seg√∫n el tipo
                    const monoSeleccionado = mo√±osDisponibles.find(mono => mono.id == monosSelect.value);
                    if (monoSeleccionado) {
                        const tipoVenta = monoSeleccionado.tipo_venta || 'individual';
                        let monosReales = cantidad;
                        if (tipoVenta === 'par') {
                            monosReales = cantidad * 2;
                        }
                        totalMonos += monosReales;
                        
                        const totalFormulario = parseFloat(formDiv.querySelector('.total-estimado')?.textContent || 0);
                        gananciaTotal += totalFormulario;
                    }
                }
            }
        });
        
        // Actualizar elementos con validaci√≥n
        const totalMonosEl = document.getElementById('total-monos');
        const tiposMonosEl = document.getElementById('tipos-monos');
        const gananciaEl = document.getElementById('ganancia-estimada');
        
        if (totalMonosEl) totalMonosEl.textContent = totalMonos;
        if (tiposMonosEl) tiposMonosEl.textContent = tiposMonos;
        if (gananciaEl) gananciaEl.textContent = '$' + gananciaTotal.toFixed(2);
    }
    
    // Event listeners para el bot√≥n de agregar
    const addButton = document.getElementById('add-mono');
    if (addButton) {
        addButton.addEventListener('click', addForm);
    } else {
        console.error('No se encontr√≥ el bot√≥n de agregar mo√±o');
    }
    
    // Event listeners para campos de cantidad
    document.addEventListener('input', function(e) {
        if (e.target.matches('[name$="-cantidad"]')) {
            const formDiv = e.target.closest('.formset-row');
            if (formDiv) {
                calcularTotalFormulario(formDiv);
                actualizarResumen();
            }
        }
    });
    
    // Inicializar resumen despu√©s de que el DOM est√© listo
    setTimeout(function() {
        actualizarResumen();
    }, 100);
});
</script>
{% endblock %}