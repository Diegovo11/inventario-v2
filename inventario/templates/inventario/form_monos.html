{% extends 'inventario/base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-ribbon me-2"></i>{{ titulo }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'inventario:lista_monos' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i><span class="d-none d-sm-inline">Volver a </span>Lista
        </a>
    </div>
</div>

<form method="post" class="row g-3">
    {% csrf_token %}
    
    <!-- Información Básica del Moño -->
    <div class="col-12 col-lg-6 mb-3">
        <div class="card shadow h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Información Básica
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="{{ form.codigo.id_for_label }}" class="form-label">{{ form.codigo.label }}</label>
                    {{ form.codigo }}
                    {% if form.codigo.help_text %}
                        <div class="form-text">{{ form.codigo.help_text }}</div>
                    {% endif %}
                    {% if form.codigo.errors %}
                        <div class="text-danger">{{ form.codigo.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }}</label>
                    {{ form.nombre }}
                    {% if form.nombre.help_text %}
                        <div class="form-text">{{ form.nombre.help_text }}</div>
                    {% endif %}
                    {% if form.nombre.errors %}
                        <div class="text-danger">{{ form.nombre.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.descripcion.id_for_label }}" class="form-label">{{ form.descripcion.label }}</label>
                    {{ form.descripcion }}
                    {% if form.descripcion.help_text %}
                        <div class="form-text">{{ form.descripcion.help_text }}</div>
                    {% endif %}
                    {% if form.descripcion.errors %}
                        <div class="text-danger">{{ form.descripcion.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuración de Venta -->
    <div class="col-12 col-lg-6 mb-3">
        <div class="card shadow h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>Configuración de Venta
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="{{ form.tipo_venta.id_for_label }}" class="form-label">{{ form.tipo_venta.label }}</label>
                    {{ form.tipo_venta }}
                    <div class="form-text">
                        <strong>Individual:</strong> Se vende por unidades<br>
                        <strong>Par:</strong> Se vende en pares (precio por par)
                    </div>
                    {% if form.tipo_venta.errors %}
                        <div class="text-danger">{{ form.tipo_venta.errors.0 }}</div>
                    {% endif %}
                </div>
                
                {% if user.userprofile.puede_ver_precios %}
                <div class="mb-3">
                    <label for="{{ form.precio_venta.id_for_label }}" class="form-label">{{ form.precio_venta.label }}</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        {{ form.precio_venta }}
                    </div>
                    <div class="form-text">Precio de venta por unidad o par (según tipo de venta)</div>
                    {% if form.precio_venta.errors %}
                        <div class="text-danger">{{ form.precio_venta.errors.0 }}</div>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-secondary">
                    <i class="fas fa-lock me-2"></i>Información de precios oculta
                </div>
                {% endif %}
                
                {% if monos and user.userprofile.puede_ver_precios %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-calculator me-2"></i>Costos Calculados</h6>
                    <p class="mb-1"><strong>Costo de Producción:</strong> ${{ monos.costo_produccion|floatformat:2 }}</p>
                    <p class="mb-0">
                        <strong>Ganancia Unitaria:</strong> 
                        <span class="{% if monos.ganancia_unitaria > 0 %}text-success{% elif monos.ganancia_unitaria < 0 %}text-danger{% else %}text-warning{% endif %}">
                            ${{ monos.ganancia_unitaria|floatformat:2 }}
                        </span>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Receta de Materiales -->
    <div class="col-12 mt-4">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Receta de Materiales
                </h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRecetaForm()">
                    <i class="fas fa-plus me-1"></i>Agregar Material
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Define qué materiales y en qué cantidades se necesitan para producir este moño.</p>
                
                {{ formset.management_form }}
                
                <!-- Debug info -->
                {% if formset.forms %}
                    <div class="alert alert-info d-none" id="debug-info">
                        <small>
                            <strong>Debug:</strong> 
                            Formset prefix: "{{ formset.prefix }}" |
                            Total forms: {{ formset.total_form_count }} |
                            {% if formset.forms.0 %}
                                Sample field names: {{ formset.forms.0.material.html_name }}, {{ formset.forms.0.cantidad_necesaria.html_name }}
                            {% endif %}
                        </small>
                    </div>
                {% endif %}
                
                <div id="receta-formset">
                    {% for form in formset %}
                        <div class="receta-form card mb-3 {% if form.DELETE %}d-none{% endif %}" data-form-idx="{{ forloop.counter0 }}">
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-12 col-md-5">
                                        <label class="form-label">Material</label>
                                        {{ form.material }}
                                        {% if form.material.errors %}
                                            <div class="text-danger small">{{ form.material.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12 col-md-4">
                                        <label class="form-label">Cantidad Necesaria</label>
                                        <div class="input-group">
                                            {{ form.cantidad_necesaria }}
                                            <span class="input-group-text material-unit">-</span>
                                        </div>
                                        {% if form.cantidad_necesaria.errors %}
                                            <div class="text-danger small">{{ form.cantidad_necesaria.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-12 col-md-2 d-flex align-items-center">
                                        <span class="material-cost text-muted fw-bold">Costo: $0.00</span>
                                    </div>
                                    
                                    <div class="col-12 col-md-1 d-flex align-items-center justify-content-end">
                                        {% if action == 'editar' or forloop.counter0 > 0 %}
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRecetaForm(this)">
                                                <i class="fas fa-trash"></i>
                                                <span class="d-md-none ms-1">Eliminar</span>
                                            </button>
                                            {{ form.DELETE }}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3 p-3 bg-light rounded">
                    <h6>Resumen de Costos</h6>
                    <p class="mb-0">
                        <strong>Costo Total de Producción: </strong>
                        <span id="costo-total" class="text-primary">$0.00</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botones de Acción -->
    <div class="col-12 mt-4">
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{% url 'inventario:lista_monos' %}" class="btn btn-secondary btn-lg d-md-inline me-md-2">
                <i class="fas fa-times me-1"></i>Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg d-md-inline">
                <i class="fas fa-save me-1"></i>
                {% if action == 'editar' %}Actualizar{% else %}Guardar{% endif %} Moño
            </button>
        </div>
    </div>
</form>

<!-- Template para nuevos forms de receta -->
<div id="empty-receta-form" class="d-none">
    <div class="receta-form card mb-3" data-form-idx="__prefix__">
        {% for hidden in formset.empty_form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        
        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-5">
                    <label class="form-label">Material</label>
                    {{ formset.empty_form.material }}
                </div>
                
                <div class="col-12 col-md-4">
                    <label class="form-label">Cantidad Necesaria</label>
                    <div class="input-group">
                        {{ formset.empty_form.cantidad_necesaria }}
                        <span class="input-group-text material-unit">-</span>
                    </div>
                </div>
                
                <div class="col-12 col-md-2 d-flex align-items-center">
                    <span class="material-cost text-muted fw-bold">Costo: $0.00</span>
                </div>
                
                <div class="col-12 col-md-1 d-flex align-items-center justify-content-end">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRecetaForm(this)">
                        <i class="fas fa-trash"></i>
                        <span class="d-md-none ms-1">Eliminar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let formIdx = parseInt('{{ formset.total_form_count }}') || 0;

function addRecetaForm() {
    const emptyForm = document.getElementById('empty-receta-form').innerHTML;
    const newForm = emptyForm.replace(/__prefix__/g, formIdx);
    
    const formsetContainer = document.getElementById('receta-formset');
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newForm;
    
    const newFormElement = tempDiv.firstElementChild;
    newFormElement.setAttribute('data-form-idx', formIdx);
    
    formsetContainer.appendChild(newFormElement);
    
    // Actualizar el management form - usar el nombre correcto del formset
    const totalFormsField = document.querySelector('input[name="recetas-TOTAL_FORMS"]');
    if (totalFormsField) {
        totalFormsField.value = parseInt(totalFormsField.value) + 1;
    }
    
    // Agregar event listeners
    addFormEventListeners(newFormElement);
    
    formIdx++;
}

function removeRecetaForm(button) {
    const formDiv = button.closest('.receta-form');
    const deleteField = formDiv.querySelector('input[name*="-DELETE"]');
    
    if (deleteField) {
        deleteField.value = 'on';
        formDiv.classList.add('d-none');
    } else {
        formDiv.remove();
        // Actualizar el total de forms si se elimina completamente
        const totalFormsField = document.querySelector('input[name="recetas-TOTAL_FORMS"]');
        if (totalFormsField) {
            totalFormsField.value = Math.max(0, parseInt(totalFormsField.value) - 1);
        }
    }
    
    updateCostoTotal();
}

function addFormEventListeners(formElement) {
    const materialSelect = formElement.querySelector('select[name*="-material"]');
    const cantidadInput = formElement.querySelector('input[name*="-cantidad_necesaria"]');
    
    if (materialSelect) {
        materialSelect.addEventListener('change', updateMaterialInfo);
    }
    
    if (cantidadInput) {
        cantidadInput.addEventListener('input', updateMaterialCost);
    }
}

function updateMaterialInfo() {
    const materialSelect = this;
    const formRow = materialSelect.closest('.receta-form');
    const unitSpan = formRow.querySelector('.material-unit');
    const cantidadInput = formRow.querySelector('input[name*="-cantidad_necesaria"]');
    
    if (materialSelect.value) {
        // Obtener información del material via AJAX
        fetch(`/inventario/ajax/material/${materialSelect.value}/info/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    unitSpan.textContent = 'unidades';
                } else {
                    unitSpan.textContent = data.unidad_base;
                    // Guardar el precio unitario en el elemento para usarlo después
                    cantidadInput.setAttribute('data-precio-unitario', data.precio_unitario);
                    updateMaterialCost.call(cantidadInput);
                }
            })
            .catch(error => {
                console.error('Error fetching material info:', error);
                unitSpan.textContent = 'unidades';
                updateMaterialCost.call(cantidadInput);
            });
    } else {
        unitSpan.textContent = '-';
        const costSpan = formRow.querySelector('.material-cost');
        costSpan.textContent = 'Costo: $0.00';
        cantidadInput.removeAttribute('data-precio-unitario');
    }
    updateCostoTotal();
}

function updateMaterialCost() {
    const cantidadInput = this;
    const formRow = cantidadInput.closest('.receta-form');
    const materialSelect = formRow.querySelector('select[name*="-material"]');
    const costSpan = formRow.querySelector('.material-cost');
    
    if (materialSelect.value && cantidadInput.value) {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precioUnitario = parseFloat(cantidadInput.getAttribute('data-precio-unitario')) || 1.0;
        const costoEstimado = cantidad * precioUnitario;
        costSpan.textContent = `Costo: $${costoEstimado.toFixed(2)}`;
    } else {
        costSpan.textContent = 'Costo: $0.00';
    }
    
    updateCostoTotal();
}

function updateCostoTotal() {
    let total = 0;
    document.querySelectorAll('.receta-form:not(.d-none) .material-cost').forEach(span => {
        const match = span.textContent.match(/\$(\d+\.?\d*)/);
        if (match) {
            total += parseFloat(match[1]);
        }
    });
    
    document.getElementById('costo-total').textContent = `$${total.toFixed(2)}`;
}

// Debug: Función para verificar datos antes de enviar
function debugFormSubmission() {
    console.log('=== DEBUG FORM SUBMISSION ===');
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    console.log('Form data:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Verificar campos específicos del formset
    const totalForms = document.querySelector('input[name="recetas-TOTAL_FORMS"]');
    console.log('Total forms field:', totalForms ? totalForms.value : 'NOT FOUND');
    
    const recetaForms = document.querySelectorAll('.receta-form:not(.d-none)');
    console.log(`Visible receta forms: ${recetaForms.length}`);
    
    recetaForms.forEach((formDiv, index) => {
        const materialSelect = formDiv.querySelector('select[name*="-material"]');
        const cantidadInput = formDiv.querySelector('input[name*="-cantidad_necesaria"]');
        console.log(`Form ${index}: material=${materialSelect ? materialSelect.value : 'NOT FOUND'}, cantidad=${cantidadInput ? cantidadInput.value : 'NOT FOUND'}`);
    });
    console.log('=== END DEBUG ===');
}

// Inicializar event listeners para forms existentes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.receta-form').forEach(addFormEventListeners);
    updateCostoTotal();
    
    // Agregar debug al botón de submit
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            debugFormSubmission();
            // No preventDefault, dejamos que el form se envíe
        });
    }
    
    // Mostrar info de debug si estamos en desarrollo
    const debugInfo = document.getElementById('debug-info');
    if (debugInfo && window.location.hostname.includes('localhost')) {
        debugInfo.classList.remove('d-none');
    }
});
</script>
{% endblock %}