{% extends "inventario/base.html" %}
{% load static %}

{% block title %}Análisis de Ventas{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .stats-card h3 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: bold;
    }
    
    .stats-card p {
        font-size: 1.1em;
        margin: 0;
        opacity: 0.9;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .chart-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        text-align: center;
    }
    
    .period-selector {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .btn-period {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        color: #6c757d;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .btn-period.active, .btn-period:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .top-productos {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .producto-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 5px solid #667eea;
    }
    
    .producto-nombre {
        font-weight: bold;
        color: #333;
    }
    
    .producto-stats {
        text-align: right;
    }
    
    .producto-cantidad {
        font-size: 1.2em;
        font-weight: bold;
        color: #667eea;
    }
    
    .producto-rendimiento {
        font-size: 0.9em;
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center mb-4">
                <i class="fas fa-chart-line"></i> Análisis de Ventas
            </h1>
        </div>
    </div>
    
    <!-- Selector de Período -->
    <div class="period-selector text-center">
        <h5>Período de Análisis</h5>
        <div class="btn-group" role="group">
            <a href="?periodo=1m" class="btn btn-period {% if periodo_seleccionado == '1m' %}active{% endif %}">
                Último Mes
            </a>
            <a href="?periodo=3m" class="btn btn-period {% if periodo_seleccionado == '3m' %}active{% endif %}">
                3 Meses
            </a>
            <a href="?periodo=6m" class="btn btn-period {% if periodo_seleccionado == '6m' %}active{% endif %}">
                6 Meses
            </a>
            <a href="?periodo=12m" class="btn btn-period {% if periodo_seleccionado == '12m' %}active{% endif %}">
                12 Meses
            </a>
            <a href="?periodo=all" class="btn btn-period {% if periodo_seleccionado == 'all' %}active{% endif %}">
                Todo el Tiempo
            </a>
        </div>
    </div>
    
    <!-- Estadísticas Generales -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <h3>${{ stats.total_ventas|floatformat:0 }}</h3>
                <p>Ingresos Totales</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <h3>{{ stats.total_cantidad_vendida }}</h3>
                <p>Moños Vendidos</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <h3>${{ stats.total_ganancias|floatformat:0 }}</h3>
                <p>Ganancia Total</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-card">
                <h3>{{ stats.rendimiento_general|floatformat:1 }}%</h3>
                <p>Rendimiento Promedio</p>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Gráfico de Ventas Mensuales -->
            <div class="chart-container">
                <div class="chart-title">Evolución de Ventas por Mes</div>
                <canvas id="ventasMensualesChart" width="400" height="200"></canvas>
            </div>
            
            <!-- Gráfico de Moños Más Vendidos -->
            <div class="chart-container">
                <div class="chart-title">Moños Más Vendidos (Por Cantidad)</div>
                <canvas id="monosVendidosChart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Top Productos por Cantidad -->
            <div class="top-productos">
                <h5 class="text-center mb-3">
                    <i class="fas fa-trophy"></i> Top Moños por Cantidad
                </h5>
                {% for mono_name, data in top_monos_cantidad %}
                <a href="{% url 'inventario:analytics_detalle_mono' data.id %}" class="text-decoration-none">
                    <div class="producto-item">
                        <div class="producto-nombre">{{ mono_name }}</div>
                        <div class="producto-stats">
                            <div class="producto-cantidad">{{ data.cantidad }} unidades</div>
                            <div class="producto-rendimiento">${{ data.ingresos|floatformat:0 }} ingresos</div>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="text-center text-muted">
                    <p>No hay datos de ventas en el período seleccionado</p>
                </div>
                {% endfor %}
            </div>
            
            <!-- Top Productos por Rendimiento -->
            <div class="top-productos">
                <h5 class="text-center mb-3">
                    <i class="fas fa-percentage"></i> Top Moños por Rendimiento
                </h5>
                {% for mono_name, data in top_monos_rendimiento %}
                <a href="{% url 'inventario:analytics_detalle_mono' data.id %}" class="text-decoration-none">
                    <div class="producto-item">
                        <div class="producto-nombre">{{ mono_name }}</div>
                        <div class="producto-stats">
                            <div class="producto-cantidad">{{ data.rendimiento|floatformat:1 }}%</div>
                            <div class="producto-rendimiento">${{ data.ganancia|floatformat:0 }} ganancia</div>
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="text-center text-muted">
                    <p>No hay datos de rendimiento en el período seleccionado</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Gráfico de Rendimiento -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <div class="chart-title">Comparativa de Rendimiento por Moño</div>
                <canvas id="rendimientoChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Información adicional -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Información del Análisis</h6>
                <p class="mb-1">
                    <strong>Período:</strong> {{ fecha_inicio|date:"d/m/Y" }} - {{ fecha_fin|date:"d/m/Y" }}
                </p>
                <p class="mb-1">
                    <strong>Transacciones analizadas:</strong> {{ stats.total_transacciones }}
                </p>
                <p class="mb-0">
                    <strong>Tipos de moños diferentes vendidos:</strong> {{ stats.tipos_monos_vendidos }}
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Datos del servidor
const chartDataRaw = "{{ chart_data_json|escapejs }}";
let chartData;
try {
    chartData = JSON.parse(chartDataRaw);
} catch (e) {
    console.error('Error parsing chart data:', e);
    chartData = { monos_cantidad: { labels: [], data: [] }, monos_rendimiento: { labels: [], data: [] }, ventas_mensuales: { labels: [], ingresos: [], cantidad_transacciones: [] } };
}

// Configuración común
Chart.defaults.font.family = 'Arial, sans-serif';
Chart.defaults.font.size = 12;

// Gráfico de Ventas Mensuales (Línea)
const ctxVentasMensuales = document.getElementById('ventasMensualesChart').getContext('2d');
const ventasMensualesChart = new Chart(ctxVentasMensuales, {
    type: 'line',
    data: {
        labels: chartData.ventas_mensuales.labels,
        datasets: [{
            label: 'Ingresos ($)',
            data: chartData.ventas_mensuales.ingresos,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
        }, {
            label: 'Número de Ventas',
            data: chartData.ventas_mensuales.cantidad_transacciones,
            borderColor: '#f093fb',
            backgroundColor: 'rgba(240, 147, 251, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.4,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            tooltip: {
                mode: 'index',
                intersect: false,
            }
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Mes'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Ingresos ($)'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Cantidad de Ventas'
                },
                grid: {
                    drawOnChartArea: false,
                },
            }
        }
    }
});

// Gráfico de Moños Más Vendidos (Barras)
const ctxMonosVendidos = document.getElementById('monosVendidosChart').getContext('2d');
const monosVendidosChart = new Chart(ctxMonosVendidos, {
    type: 'bar',
    data: {
        labels: chartData.monos_cantidad.labels,
        datasets: [{
            label: 'Cantidad Vendida',
            data: chartData.monos_cantidad.data,
            backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(201, 203, 207, 0.8)'
            ],
            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(201, 203, 207, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y + ' unidades vendidas';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Cantidad Vendida'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Tipo de Moño'
                }
            }
        }
    }
});

// Gráfico de Rendimiento (Barras Horizontales)
const ctxRendimiento = document.getElementById('rendimientoChart').getContext('2d');
const rendimientoChart = new Chart(ctxRendimiento, {
    type: 'bar',
    data: {
        labels: chartData.monos_rendimiento.labels,
        datasets: [{
            label: 'Rendimiento (%)',
            data: chartData.monos_rendimiento.data,
            backgroundColor: function(context) {
                const value = context.parsed.x;
                if (value > 50) return 'rgba(40, 167, 69, 0.8)';  // Verde para buen rendimiento
                if (value > 25) return 'rgba(255, 193, 7, 0.8)';   // Amarillo para rendimiento medio
                return 'rgba(220, 53, 69, 0.8)';                   // Rojo para bajo rendimiento
            },
            borderColor: function(context) {
                const value = context.parsed.x;
                if (value > 50) return 'rgba(40, 167, 69, 1)';
                if (value > 25) return 'rgba(255, 193, 7, 1)';
                return 'rgba(220, 53, 69, 1)';
            },
            borderWidth: 2
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.x.toFixed(1) + '% de rendimiento';
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Rendimiento (%)'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Tipo de Moño'
                }
            }
        }
    }
});
</script>
{% endblock %}