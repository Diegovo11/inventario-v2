{% extends 'inventario/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0"><i class="fas fa-sync-alt"></i> {{ titulo }}</h3>
                </div>
                <div class="card-body">
                    
                    {% if not resultado.ejecutado %}
                    <!-- FORMULARIO INICIAL -->
                    <div class="alert alert-info">
                        <h4 class="alert-heading"><i class="fas fa-info-circle"></i> ¿Qué hace esta herramienta?</h4>
                        <p>Esta herramienta migra las ventas antiguas que se registraron <strong>ANTES</strong> de que existiera el modelo <code>VentaMonos</code>.</p>
                        <hr>
                        <p class="mb-0"><strong>Proceso:</strong></p>
                        <ol>
                            <li>Lee los <code>MovimientoEfectivo</code> de tipo "venta"</li>
                            <li>Extrae el nombre de la lista de producción</li>
                            <li>Busca los detalles de moños vendidos</li>
                            <li>Crea registros en <code>VentaMonos</code> para analytics</li>
                        </ol>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong> Primero ejecuta en modo <strong>SIMULACIÓN</strong> para ver qué se hará.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <form method="post" id="form-simular">
                                {% csrf_token %}
                                <input type="hidden" name="dry_run" value="true">
                                <button type="submit" class="btn btn-info btn-lg w-100">
                                    <i class="fas fa-search"></i> Simular Migración (No guarda cambios)
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <form method="post" id="form-ejecutar" onsubmit="return confirmarEjecucion()">
                                {% csrf_token %}
                                <input type="hidden" name="dry_run" value="false">
                                <button type="submit" class="btn btn-success btn-lg w-100">
                                    <i class="fas fa-check"></i> Ejecutar Migración Real
                                </button>
                            </form>
                        </div>
                    </div>

                    <script>
                    function confirmarEjecucion() {
                        return confirm('¿Estás seguro de ejecutar la migración REAL? Esto creará registros en la base de datos.');
                    }
                    </script>

                    {% else %}
                    <!-- RESULTADOS -->
                    <div class="alert {% if resultado.dry_run %}alert-warning{% else %}alert-success{% endif %}">
                        <h4 class="alert-heading">
                            {% if resultado.dry_run %}
                                <i class="fas fa-search"></i> SIMULACIÓN COMPLETADA
                            {% else %}
                                <i class="fas fa-check-circle"></i> MIGRACIÓN EJECUTADA
                            {% endif %}
                        </h4>
                        <p class="mb-0">
                            {% if resultado.dry_run %}
                                Esto es una simulación. No se guardaron cambios en la base de datos.
                            {% else %}
                                Los cambios se guardaron exitosamente en la base de datos.
                            {% endif %}
                        </p>
                    </div>

                    <!-- RESUMEN -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h2 class="display-4">{{ resultado.ventas_creadas }}</h2>
                                    <p class="mb-0">{% if resultado.dry_run %}Se crearían{% else %}Ventas Creadas{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h2 class="display-4">{{ resultado.ventas_ya_existen }}</h2>
                                    <p class="mb-0">Ya Existían</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h2 class="display-4">{{ resultado.errores }}</h2>
                                    <p class="mb-0">Errores</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DETALLES -->
                    {% if resultado.detalles %}
                    <h4 class="mb-3">Detalles de Movimientos Procesados:</h4>
                    {% for detalle in resultado.detalles %}
                    <div class="card mb-3">
                        <div class="card-header {% if detalle.estado == 'creadas' or detalle.estado == 'simuladas' %}bg-success text-white{% elif detalle.estado == 'ya_existe' %}bg-warning{% else %}bg-secondary text-white{% endif %}">
                            <h5 class="mb-0">
                                {% if detalle.estado == 'creadas' %}
                                    <i class="fas fa-check-circle"></i>
                                {% elif detalle.estado == 'simuladas' %}
                                    <i class="fas fa-search"></i>
                                {% elif detalle.estado == 'ya_existe' %}
                                    <i class="fas fa-exclamation-circle"></i>
                                {% else %}
                                    <i class="fas fa-info-circle"></i>
                                {% endif %}
                                {{ detalle.concepto }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Fecha:</strong> {{ detalle.fecha|date:"Y-m-d H:i" }}</p>
                            <p><strong>Monto Total:</strong> ${{ detalle.monto|floatformat:2 }}</p>
                            <p><strong>Lista:</strong> {{ detalle.lista }}</p>
                            <p><strong>Estado:</strong> 
                                <span class="badge {% if detalle.estado == 'creadas' %}bg-success{% elif detalle.estado == 'simuladas' %}bg-info{% elif detalle.estado == 'ya_existe' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ detalle.mensaje }}
                                </span>
                            </p>

                            {% if detalle.ventas_creadas %}
                            <h6 class="mt-3">Ventas {% if resultado.dry_run %}que se crearían{% else %}creadas{% endif %}:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Moño</th>
                                            <th>Cantidad</th>
                                            <th>Tipo</th>
                                            <th>Ingreso</th>
                                            <th>Ganancia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for venta in detalle.ventas_creadas %}
                                        <tr>
                                            <td>{{ venta.mono }}</td>
                                            <td>{{ venta.cantidad }}</td>
                                            <td><span class="badge bg-primary">{{ venta.tipo }}</span></td>
                                            <td>${{ venta.ingreso|floatformat:2 }}</td>
                                            <td>${{ venta.ganancia|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- ERRORES -->
                    {% if resultado.errores_detalle %}
                    <h4 class="text-danger mb-3">Errores Encontrados:</h4>
                    {% for error in resultado.errores_detalle %}
                    <div class="alert alert-danger">
                        <strong>{{ error.concepto }}</strong><br>
                        Error: {{ error.error }}
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- ACCIONES -->
                    <div class="mt-4">
                        {% if resultado.dry_run and resultado.ventas_creadas > 0 %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Simulación exitosa.</strong> Ahora puedes ejecutar la migración REAL para guardar los cambios.
                        </div>
                        <form method="post" onsubmit="return confirmarEjecucion()">
                            {% csrf_token %}
                            <input type="hidden" name="dry_run" value="false">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check"></i> Ejecutar Migración Real Ahora
                            </button>
                        </form>
                        {% elif not resultado.dry_run %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Migración completada.</strong> Ahora ve a Analytics para ver los datos.
                        </div>
                        <a href="{% url 'inventario:analytics_dashboard' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-chart-line"></i> Ir a Analytics
                        </a>
                        <a href="{% url 'inventario:diagnostico_ventas_web' %}" class="btn btn-info btn-lg">
                            <i class="fas fa-bug"></i> Verificar Diagnóstico
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'inventario:home' %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-home"></i> Volver al Inicio
                        </a>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
